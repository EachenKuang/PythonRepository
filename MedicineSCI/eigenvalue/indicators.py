# -*- coding: utf-8 -*-
# 计算各类指标
import xlrd
import numpy as np
import pandas as pd

# 读取期刊列表
# @param path: 期刊列表文件路径
# @return
def read_ESIMasterJournalList(path):
    journal_dict = {}
    workbook = xlrd.open_workbook(path)
    booksheet = workbook.sheet_by_index(0)
    for i in range(1, booksheet.nrows):
        for j in range(0, 3):
            title = booksheet.cell(i, j).value
            category = booksheet.cell(i, 5).value
            print title, category
        journal_dict[title] = category
    return journal_dict


# Util
# @param my_list, my_dict
# my_dict需要事先初始化传入
# @return my_dict
def list2dict(my_list, my_dict):
    for l in my_list:
        if my_dict.has_key(l):
            my_dict[l] += 1
        else:
            my_dict[l] = 1
    return my_dict


# Util: 字典转化为向量，缺失处补0
# @param my_dict
#        my_list
# @return my_vector
def dict2vector(my_dict, my_list):
    my_vector = np.zeros(len(my_list))  # initialize
    for k in my_dict.keys():
        my_vector[my_list.index(k)] = my_dict[k]
    return my_vector


# Util: 计算cosine夹角
def sim(a,b):
    dot_product = 0.0
    normA = 0.0
    normB = 0.0
    for x, y in zip(a, b):
        dot_product+=x*y
        normA += x**2
        normB += y**2
    if normA == 0.0 or normB == 0.0:
        return None
    else:
        return dot_product/((normA*normB)**0.5)


# 从theta矩阵
# @param theta_path theta矩阵路径
#        topic_num 主题数量
#        article_num 文献总数
#        selected_topic 选择的主题标号
def theta2subset(theta_path, topic_num, article_num, selected_topic):
    theta = open(theta_path)
    df = pd.read_csv(filepath_or_buffer=theta_path, sep='\t', header=None, names=range(1, topic_num+1), index_col=False)
    article_topic = df.idxmax(axis=1)   # 每篇文献属于的主题
    return list(article_topic[article_topic == selected_topic].index+1)


# 计算学科交叉性指标
# @param:
# theta: document*topic
# paperIDs: paperID list (主题下的PaperID)
# paperCR_path: paperID -> CR file path (完整的PaperID集合)
def get_subject_displine(paperIDs, paper_subjects_path):
    paper_subjects_file = open(paper_subjects_path, 'r')     # paperID; subjects
    subjects_all_times = {}     # 所有文献学科类别出现次数
    cr_total = 0.0          # 引文总数
    # 扫描统计共有多少个学科Begin
    all_subjects = []
    M = len(paperIDs)   # 主题下文献篇数
    print M
    for line in paper_subjects_file.readlines():
        splits = line.split(';')
        paperID = int(splits[0])
        if paperID not in paperIDs:     # 不属于该主题的文献，跳过
            continue
        cr_total += (len(splits) - 1)  # 引文数计数
        all_subjects += splits[1:len(splits)]
        all_subjects = list(set(all_subjects))  # 所有出现过的学科去重
    N = len(all_subjects)   # 学科数
    print N
    co_occurence_matrix = pd.DataFrame(np.zeros((M, N)), index=paperIDs, columns=all_subjects)  # 共现矩阵
    # 扫描统计共有多少个学科End
    # 各学科类别引文计数Begin
    paper_subjects_file.seek(0)
    for line in paper_subjects_file.readlines():
        splits = line.split(';')
        paperID = int(splits[0])
        if paperID not in paperIDs:     # 不属于该主题的文献，跳过
            continue
        subjects = splits[1:len(splits)]
        subjects_times = {}
        subjects_times = list2dict(subjects, subjects_times)            # 文献内引文的学科
        subjects_all_times = list2dict(subjects, subjects_all_times)    # 所有文献内引文的学科
        my_vector = dict2vector(subjects_times, all_subjects)           # 生成文献对应的行向量
        co_occurence_matrix.loc[paperID,] = my_vector   # 共现矩阵      # 更新文献对应共现矩阵的行向量
    # 各学科类别引文计数End
    p = np.array(subjects_all_times.values())/cr_total
    print len(subjects_all_times.values())
    # co_occurence_matrix = co_occurence_matrix[co_occurence_matrix!=0] = 1   # 转换为0-1共现矩阵
    co_occurence_matrix = co_occurence_matrix / cr_total    # 将共现矩阵所有元素除以引文总数
    # subjects_subjects_matrix = np.matrix(co_occurence_matrix.T) * np.matrix(co_occurence_matrix)    # 学科-学科矩阵
    # Step 5, 6: 计算学科交叉度Begin
    subjects_displine = 0
    for i in range(0, len(all_subjects)):
        for j in range(i+1, len(all_subjects)):
            cosine = sim(co_occurence_matrix.iloc[:, i], co_occurence_matrix.iloc[:, j])
            subjects_displine += p[i] * p[j] * cosine     # pi*pj*dij
    # 计算学科交叉度End
    print subjects_displine
    return subjects_displine



def main():
    '''
    topic1 = [6949, 7000, 7005, 7006, 7032, 7033, 7044, 7048, 7051, 7063, 7068, 7071, 7074, 7093, 7103, 7109, 7124,
              7139, 7152, 7155, 7163, 7188, 7195, 7203, 7204, 7224, 7240, 7261, 7274, 7279, 7287, 7292, 7297, 7318,
              7324, 7326, 7339, 7346, 7347, 7348, 7353, 7354, 7355, 7381, 7383, 7386, 7399, 7412, 7413, 7417, 7425,
              7444, 7462, 7475, 7480, 7482, 7483, 7484, 7489, 7495, 7497, 7502, 7503, 7509, 7536, 7550, 7551, 7560,
              7573, 7580, 7582, 7594, 7621, 7626, 7638, 7643, 7659, 7662, 7664, 7671, 7675, 7681, 7685, 7702, 7713]
    topic2 = [6943, 6951, 6964, 6965, 6972, 6974, 6978, 6979, 6989, 6991, 7004, 7047, 7049, 7073, 7081, 7083, 7084,
              7100, 7105, 7108, 7117, 7123, 7125, 7126, 7128, 7135, 7143, 7151, 7154, 7157, 7161, 7164, 7167, 7168,
              7171, 7176, 7191, 7201, 7221, 7227, 7229, 7231, 7243, 7251, 7256, 7264, 7282, 7293, 7295, 7299, 7307,
              7328, 7335, 7342, 7343, 7345, 7356, 7364, 7405, 7415, 7427, 7430, 7439, 7449, 7471, 7472, 7476, 7485,
              7531, 7532, 7538, 7540, 7553, 7559, 7575, 7585, 7588, 7589, 7596, 7597, 7598, 7600, 7616, 7636, 7657,
              7667, 7672, 7673, 7703, 7704, 7718]
    topic3 = [6940, 6948, 6973, 7001, 7012, 7031, 7058, 7075, 7078, 7082, 7089, 7106, 7107, 7113, 7114, 7116, 7130,
              7133, 7141, 7147, 7156, 7162, 7178, 7180, 7190, 7197, 7207, 7222, 7233, 7241, 7245, 7258, 7259, 7276,
              7285, 7288, 7298, 7304, 7312, 7329, 7369, 7372, 7374, 7384, 7400, 7402, 7404, 7419, 7445, 7459, 7493,
              7516, 7545, 7549, 7562, 7574, 7578, 7581, 7583, 7604, 7614, 7629, 7634, 7642, 7700, 7711]
    topic4 = [6945, 6952, 6968, 6981, 6982, 6992, 7007, 7043, 7064, 7076, 7090, 7098, 7110, 7115, 7127, 7131, 7132,
              7137, 7146, 7169, 7198, 7209, 7234, 7250, 7252, 7280, 7290, 7317, 7323, 7357, 7373, 7376, 7380, 7394,
              7409, 7448, 7453, 7460, 7477, 7478, 7490, 7508, 7537, 7543, 7546, 7558, 7601, 7603, 7609, 7628, 7630,
              7637, 7640, 7665, 7701, 7715]
    topic5 = [6942, 6950, 6966, 6969, 6985, 6986, 6988, 6993, 6997, 7013, 7015, 7017, 7029, 7030, 7037, 7039, 7042,
              7053, 7056, 7057, 7085, 7086, 7104, 7136, 7150, 7153, 7172, 7175, 7177, 7184, 7192, 7193, 7199, 7210,
              7211, 7216, 7220, 7236, 7242, 7268, 7273, 7275, 7283, 7294, 7311, 7322, 7337, 7351, 7359, 7363, 7366,
              7368, 7377, 7387, 7388, 7395, 7401, 7420, 7421, 7431, 7442, 7452, 7463, 7470, 7481, 7486, 7492, 7498,
              7506, 7513, 7515, 7518, 7519, 7523, 7524, 7530, 7541, 7568, 7570, 7576, 7584, 7592, 7610, 7624, 7625,
              7627, 7635, 7645, 7647, 7651, 7653, 7654, 7656, 7663, 7690, 7695, 7696, 7714]
    topic6 = [6958, 6967, 6976, 7008, 7018, 7026, 7028, 7045, 7050, 7054, 7062, 7066, 7070, 7091, 7092, 7111, 7121,
              7129, 7140, 7149, 7173, 7174, 7179, 7181, 7182, 7212, 7213, 7214, 7223, 7235, 7248, 7254, 7255, 7271,
              7286, 7301, 7306, 7313, 7320, 7321, 7332, 7341, 7349, 7358, 7361, 7365, 7370, 7385, 7389, 7390, 7391,
              7396, 7423, 7438, 7441, 7451, 7454, 7473, 7474, 7479, 7539, 7564, 7599, 7607, 7611, 7631, 7639, 7649,
              7680, 7682, 7688, 7708]
    topic7 = [6944, 6947, 6954, 6959, 6960, 6987, 6998, 6999, 7016, 7019, 7024, 7034, 7038, 7046, 7069, 7077, 7097,
              7099, 7102, 7118, 7148, 7158, 7186, 7196, 7232, 7239, 7266, 7267, 7270, 7281, 7296, 7302, 7315, 7325,
              7362, 7378, 7410, 7416, 7422, 7428, 7446, 7461, 7465, 7466, 7496, 7525, 7561, 7563, 7571, 7586, 7615,
              7618, 7619, 7622, 7632, 7644, 7650, 7655, 7661, 7670, 7698, 7705]
    topic8 = [6946, 6955, 6963, 6970, 6971, 6975, 6977, 6983, 6984, 6990, 6996, 7003, 7009, 7010, 7011, 7040, 7052,
              7072, 7080, 7087, 7122, 7134, 7138, 7142, 7145, 7187, 7219, 7230, 7238, 7253, 7262, 7263, 7272, 7308,
              7309, 7314, 7333, 7360, 7393, 7406, 7408, 7414, 7424, 7426, 7432, 7436, 7437, 7450, 7456, 7457, 7458,
              7487, 7507, 7511, 7517, 7520, 7522, 7535, 7542, 7552, 7555, 7556, 7565, 7579, 7587, 7591, 7593, 7595,
              7606, 7608, 7612, 7641, 7646, 7658, 7660, 7668, 7677, 7679, 7691, 7692, 7697, 7699, 7717, 7719]
    topic9 = [6953, 6961, 6962, 6980, 7002, 7021, 7023, 7025, 7027, 7035, 7055, 7060, 7061, 7065, 7067, 7079, 7088,
              7094, 7096, 7101, 7112, 7120, 7144, 7159, 7165, 7183, 7185, 7194, 7202, 7205, 7208, 7218, 7225, 7228,
              7249, 7260, 7265, 7269, 7277, 7278, 7284, 7289, 7310, 7319, 7330, 7331, 7334, 7340, 7344, 7367, 7375,
              7382, 7392, 7397, 7398, 7403, 7411, 7418, 7429, 7433, 7434, 7440, 7443, 7447, 7464, 7468, 7469, 7488,
              7499, 7500, 7504, 7505, 7510, 7514, 7527, 7529, 7533, 7534, 7548, 7557, 7569, 7590, 7605, 7613, 7617,
              7633, 7648, 7652, 7669, 7676, 7678, 7693, 7694, 7707, 7709, 7712]
    topic10 = [6941, 6956, 6957, 6994, 6995, 7014, 7020, 7022, 7036, 7041, 7059, 7095, 7119, 7160, 7166, 7170, 7189,
               7200, 7206, 7215, 7217, 7226, 7237, 7244, 7246, 7247, 7257, 7291, 7300, 7303, 7305, 7316, 7327, 7336,
               7338, 7350, 7352, 7371, 7379, 7407, 7435, 7455, 7467, 7491, 7494, 7501, 7512, 7521, 7526, 7528, 7544,
               7547, 7554, 7566, 7567, 7572, 7577, 7602, 7620, 7623, 7666, 7674, 7683, 7684, 7686, 7687, 7689, 7706,
               7710, 7716, 7720]
     '''
    '''
    topic1=[7144, 7159, 7165, 7179, 7183, 7185, 7194, 7202, 7203, 7208, 7218, 7249, 7260, 7261, 7269, 7274, 7277, 7278,
            7284, 7289, 7307, 7310, 7319, 7331, 7334, 7341, 7367, 7375, 7382, 7392, 7397, 7398, 7399, 7403, 7411, 7418,
            7424, 7425, 7433, 7438, 7440, 7443, 7447, 7450, 7462, 7468, 7469, 7488, 7489, 7499, 7500, 7504, 7505, 7527,
            7529, 7533, 7534, 7548, 7550, 7557, 7569, 7570]
    topic2=[7125, 7130, 7140, 7142, 7145, 7153, 7162, 7166, 7172, 7181, 7189, 7226, 7233, 7234, 7237, 7241, 7248, 7272,
            7298, 7305, 7338, 7371, 7376, 7379, 7384, 7390, 7432, 7436, 7437, 7448, 7455, 7477, 7507, 7511, 7520, 7525,
            7528, 7535, 7555, 7562, 7567, 7583]
    topic3=[7127, 7129, 7137, 7141, 7156, 7173, 7182, 7207, 7213, 7214, 7215, 7219, 7228, 7235, 7243, 7255, 7265, 7276,
            7281, 7306, 7313, 7321, 7323, 7330, 7332, 7340, 7342, 7344, 7349, 7361, 7370, 7380, 7385, 7389, 7396, 7453,
            7454, 7460, 7474, 7478, 7483, 7494, 7546, 7558, 7564]
    topic4=[7123, 7124, 7126, 7128, 7151, 7157, 7161, 7164, 7167, 7168, 7169, 7171, 7174, 7176, 7191, 7192, 7201, 7210,
            7211, 7220, 7221, 7222, 7227, 7229, 7240, 7242, 7251, 7282, 7290, 7293, 7295, 7297, 7299, 7312, 7322, 7328,
            7329, 7345, 7356, 7364, 7401, 7405, 7427, 7430, 7449, 7463, 7471, 7472, 7476, 7485, 7486, 7518, 7531, 7532,
            7559, 7568, 7585]
    topic5=[7133, 7135, 7136, 7139, 7147, 7148, 7149, 7154, 7155, 7163, 7178, 7209, 7231, 7236, 7256, 7258, 7268, 7283,
            7287, 7288, 7291, 7317, 7343, 7359, 7369, 7374, 7381, 7394, 7400, 7402, 7415, 7419, 7459, 7479, 7480, 7481,
            7490, 7493, 7506, 7510, 7515, 7516, 7540, 7545, 7549, 7573, 7574, 7578, 7580, 7584]
    topic6=[7121, 7186, 7190, 7195, 7225, 7232, 7239, 7270, 7292, 7303, 7346, 7347, 7350, 7383, 7410, 7417, 7428, 7429,
            7434, 7461, 7465, 7482, 7484, 7497, 7509, 7560, 7563, 7581, 7586]
    topic7=[7150, 7152, 7177, 7184, 7188, 7193, 7199, 7205, 7206, 7216, 7224, 7238, 7254, 7271, 7273, 7275, 7279, 7294,
            7301, 7311, 7320, 7337, 7351, 7358, 7363, 7366, 7377, 7388, 7391, 7395, 7420, 7421, 7431, 7442, 7451, 7452,
            7470, 7492, 7503, 7513, 7514, 7523, 7524, 7530, 7541, 7566, 7576]
    topic8=[7132, 7158, 7160, 7170, 7196, 7200, 7217, 7244, 7246, 7247, 7252, 7257, 7266, 7267, 7296, 7300, 7302, 7315,
            7316, 7325, 7327, 7336, 7352, 7362, 7378, 7404, 7407, 7416, 7422, 7435, 7445, 7446, 7464, 7466, 7467, 7491,
            7496, 7501, 7512, 7519, 7521, 7536, 7553, 7554, 7561, 7571, 7572, 7577]
    topic9=[7122, 7131, 7175, 7198, 7204, 7212, 7223, 7280, 7286, 7318, 7324, 7326, 7333, 7339, 7348, 7353, 7354, 7355,
            7365, 7368, 7386, 7387, 7412, 7413, 7423, 7441, 7444, 7473, 7475, 7487, 7495, 7498, 7502, 7526, 7539, 7551,
            7575, 7582]
    topic10=[7134, 7138, 7143, 7146, 7180, 7187, 7197, 7230, 7245, 7250, 7253, 7259, 7262, 7263, 7264, 7285, 7304, 7308,
             7309, 7314, 7335, 7357, 7360, 7372, 7373, 7393, 7406, 7408, 7409, 7414, 7426, 7439, 7456, 7457, 7458, 7508,
             7517, 7522, 7537, 7538, 7542, 7543, 7544, 7547, 7552, 7556, 7565, 7579]
    '''
    '''
    topic1 = [7289, 7303, 7308, 7312, 7316, 7323, 7326, 7337, 7350, 7438, 7441, 7445, 7450, 7455, 7484, 7498, 7504,
              7509, 7521, 7539, 7544]
    topic2 = [7285, 7290, 7291, 7298, 7304, 7309, 7314, 7333, 7360, 7364, 7372, 7374, 7384, 7393, 7406, 7408, 7414,
              7419, 7456, 7457, 7458, 7483, 7493, 7512, 7517, 7522, 7537, 7547, 7552, 7558, 7572, 7583]
    topic3 = [7296, 7300, 7302, 7325, 7327, 7336, 7343, 7352, 7362, 7365, 7378, 7380, 7404, 7407, 7416, 7422, 7446,
              7466, 7467, 7481, 7491, 7496, 7501, 7554, 7561, 7571, 7577]
    topic4 = [7305, 7348, 7371, 7376, 7379, 7390, 7426, 7432, 7436, 7437, 7439, 7442, 7448, 7470, 7507, 7511, 7516,
              7520, 7525, 7526, 7528, 7535, 7542, 7555, 7556, 7562, 7565, 7566, 7567]
    topic5 = [7286, 7301, 7313, 7315, 7320, 7330, 7332, 7339, 7349, 7358, 7370, 7385, 7389, 7391, 7396, 7410, 7453,
              7454, 7460, 7461, 7464, 7473, 7478, 7479, 7494, 7536, 7564]
    topic6 = [7284, 7310, 7319, 7331, 7334, 7341, 7347, 7367, 7375, 7382, 7392, 7397, 7398, 7411, 7413, 7418, 7425,
              7433, 7435, 7440, 7443, 7447, 7462, 7468, 7488, 7489, 7499, 7500, 7505, 7514, 7527, 7529, 7533, 7534,
              7548, 7550, 7569, 7580]
    topic7 = [7287, 7311, 7318, 7321, 7324, 7353, 7354, 7355, 7361, 7368, 7381, 7386, 7395, 7399, 7412, 7415, 7417,
              7423, 7444, 7451, 7475, 7480, 7487, 7495, 7502, 7551, 7570, 7575, 7582]
    topic8 = [7288, 7292, 7307, 7338, 7340, 7344, 7346, 7383, 7400, 7402, 7403, 7424, 7428, 7429, 7434, 7465, 7469,
              7482, 7490, 7497, 7510, 7519, 7540, 7545, 7549, 7560, 7563, 7573, 7578, 7581, 7586]
    topic9 = [7294, 7297, 7322, 7328, 7351, 7356, 7359, 7363, 7366, 7369, 7377, 7387, 7388, 7401, 7420, 7421, 7431,
              7459, 7463, 7472, 7486, 7492, 7503, 7506, 7513, 7515, 7518, 7523, 7524, 7530, 7531, 7532, 7541, 7557,
              7568, 7574, 7576, 7584]
    topic10 = [7293, 7295, 7299, 7306, 7317, 7329, 7335, 7342, 7345, 7357, 7373, 7394, 7405, 7409, 7427, 7430, 7449,
               7452, 7471, 7474, 7476, 7477, 7485, 7508, 7538, 7543, 7546, 7553, 7559, 7579, 7585]
    '''
    topic1 = [7124, 7125, 7158, 7172, 7196, 7199, 7238, 7266, 7267, 7271, 7283, 7296, 7302, 7321, 7327, 7352, 7364,
              7365, 7378, 7416, 7442, 7445, 7446]
    topic2 = [7122, 7148, 7154, 7177, 7179, 7188, 7193, 7195, 7203, 7212, 7224, 7229, 7236, 7242, 7274, 7292, 7311,
              7318, 7324, 7326, 7339, 7347, 7353, 7354, 7355, 7368, 7383, 7386, 7387, 7391, 7399, 7410, 7417, 7438,
              7444]
    topic3 = [7130, 7131, 7145, 7153, 7166, 7206, 7207, 7219, 7220, 7226, 7237, 7248, 7258, 7262, 7281, 7308, 7338,
              7348, 7350, 7371, 7379, 7390, 7419, 7422, 7424, 7432, 7435, 7437, 7448, 7450, 7452, 7455]
    topic4 = [7134, 7138, 7142, 7156, 7162, 7178, 7180, 7181, 7184, 7187, 7197, 7230, 7233, 7241, 7243, 7245, 7259,
              7263, 7272, 7285, 7298, 7304, 7314, 7333, 7360, 7372, 7373, 7384, 7393, 7406, 7414, 7426, 7436, 7456]
    topic5 = [7128, 7135, 7150, 7152, 7167, 7169, 7175, 7191, 7192, 7204, 7210, 7211, 7221, 7240, 7261, 7273, 7275,
              7279, 7294, 7297, 7312, 7322, 7328, 7351, 7356, 7363, 7377, 7395, 7401, 7413, 7420, 7421, 7425, 7431]
    topic6 = [7123, 7126, 7127, 7143, 7146, 7151, 7157, 7161, 7164, 7168, 7171, 7176, 7201, 7209, 7222, 7231, 7234,
              7250, 7251, 7253, 7264, 7280, 7282, 7291, 7293, 7295, 7299, 7306, 7317, 7329, 7335, 7342, 7345, 7357,
              7402, 7405, 7409, 7427, 7449]
    topic7 = [7140, 7144, 7155, 7159, 7165, 7183, 7185, 7194, 7202, 7205, 7208, 7218, 7225, 7249, 7260, 7269, 7277,
              7278, 7284, 7289, 7307, 7310, 7319, 7331, 7334, 7341, 7344, 7367, 7375, 7392, 7397, 7398, 7403, 7411,
              7418, 7429, 7433, 7434, 7440, 7443, 7447]
    topic8 = [7133, 7136, 7139, 7147, 7149, 7163, 7189, 7190, 7198, 7216, 7227, 7232, 7254, 7256, 7268, 7287, 7288,
              7315, 7343, 7346, 7359, 7366, 7369, 7380, 7381, 7382, 7388, 7394, 7400, 7404, 7408, 7412, 7415, 7423,
              7430, 7441]
    topic9 = [7129, 7137, 7141, 7174, 7182, 7186, 7213, 7214, 7215, 7223, 7228, 7235, 7239, 7255, 7265, 7276, 7286,
              7301, 7313, 7320, 7323, 7332, 7337, 7340, 7349, 7358, 7361, 7370, 7385, 7389, 7396, 7439, 7451, 7453,
              7454]
    topic10 = [7121, 7132, 7160, 7170, 7173, 7200, 7217, 7244, 7246, 7247, 7252, 7257, 7270, 7290, 7300, 7303, 7305,
               7309, 7316, 7325, 7330, 7336, 7362, 7374, 7376, 7407, 7428]

    topic = []
    topic.append(topic1)
    topic.append(topic2)
    topic.append(topic3)
    topic.append(topic4)
    topic.append(topic5)
    topic.append(topic6)
    topic.append(topic7)
    topic.append(topic8)
    topic.append(topic9)
    topic.append(topic10)

    # read_ESIMasterJournalList('Medical/ESIMasterJournalList.xlsx')
    # get_subject_displine(['3','4','5'], 'paper_CR.txt')
    for i in range(0,10):
        # selected_articles = theta2subset('lda_1000.theta', 10, 8283, i)
        get_subject_displine(topic[i], 'paper_CR.txt')
    # get_subject_displine(,'paper_CR.txt')

if __name__ == '__main__':
    main()